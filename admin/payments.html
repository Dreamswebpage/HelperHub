<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Payments Management - Admin Panel</title>
    <link rel="stylesheet" href="../assets/css/style.css">
    <link rel="stylesheet" href="assets/css/admin.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
</head>
<body class="admin-dashboard">
    <!-- Sidebar -->
    <div class="admin-sidebar">
        <div class="sidebar-header">
            <div class="logo">
                <i class="fas fa-user-shield"></i>
                <h2>Admin Panel</h2>
            </div>
            <button class="sidebar-toggle">
                <i class="fas fa-bars"></i>
            </button>
        </div>
        
        <div class="sidebar-menu">
            <a href="dashboard.html" class="menu-item">
                <i class="fas fa-tachometer-alt"></i>
                <span>Dashboard</span>
            </a>
            <a href="orders.html" class="menu-item">
                <i class="fas fa-shopping-cart"></i>
                <span>Orders</span>
                <span class="badge" id="ordersBadge">0</span>
            </a>
            <a href="payments.html" class="menu-item active">
                <i class="fas fa-credit-card"></i>
                <span>Payments</span>
                <span class="badge" id="paymentsBadge">0</span>
            </a>
            <a href="settings.html" class="menu-item">
                <i class="fas fa-cog"></i>
                <span>Settings</span>
            </a>
        </div>
        
        <div class="sidebar-footer">
            <div class="admin-profile">
                <div class="profile-img">
                    <i class="fas fa-user"></i>
                </div>
                <div class="profile-info">
                    <strong>Admin User</strong>
                    <small>Super Administrator</small>
                </div>
            </div>
            <button id="logoutBtn" class="btn btn-danger btn-block">
                <i class="fas fa-sign-out-alt"></i> Logout
            </button>
        </div>
    </div>

    <!-- Main Content -->
    <div class="admin-main">
        <!-- Top Bar -->
        <div class="admin-topbar">
            <div class="topbar-left">
                <h1>Payments Management</h1>
                <p>View and manage payment transactions</p>
            </div>
            <div class="topbar-right">
                <div class="payment-stats">
                    <div class="stat-item">
                        <span class="stat-label">Total Revenue:</span>
                        <span class="stat-value" id="totalRevenue">₹0.00</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">This Month:</span>
                        <span class="stat-value" id="monthRevenue">₹0.00</span>
                    </div>
                </div>
                <button class="btn btn-success" id="refreshPaymentsBtn">
                    <i class="fas fa-sync-alt"></i> Refresh
                </button>
            </div>
        </div>

        <!-- Summary Cards -->
        <div class="summary-cards">
            <div class="summary-card success">
                <div class="summary-icon">
                    <i class="fas fa-check-circle"></i>
                </div>
                <div class="summary-content">
                    <h3 id="successfulPayments">0</h3>
                    <p>Successful Payments</p>
                </div>
            </div>
            
            <div class="summary-card warning">
                <div class="summary-icon">
                    <i class="fas fa-clock"></i>
                </div>
                <div class="summary-content">
                    <h3 id="pendingPayments">0</h3>
                    <p>Pending Payments</p>
                </div>
            </div>
            
            <div class="summary-card danger">
                <div class="summary-icon">
                    <i class="fas fa-times-circle"></i>
                </div>
                <div class="summary-content">
                    <h3 id="failedPayments">0</h3>
                    <p>Failed Payments</p>
                </div>
            </div>
            
            <div class="summary-card info">
                <div class="summary-icon">
                    <i class="fas fa-exchange-alt"></i>
                </div>
                <div class="summary-content">
                    <h3 id="totalTransactions">0</h3>
                    <p>Total Transactions</p>
                </div>
            </div>
        </div>

        <!-- Filters -->
        <div class="filters-section">
            <div class="filters-grid">
                <div class="filter-group">
                    <label>Payment Status</label>
                    <select id="paymentStatusFilter" class="form-control">
                        <option value="all">All Status</option>
                        <option value="successful">Successful</option>
                        <option value="pending">Pending</option>
                        <option value="failed">Failed</option>
                        <option value="refunded">Refunded</option>
                    </select>
                </div>
                
                <div class="filter-group">
                    <label>Payment Method</label>
                    <select id="paymentMethodFilter" class="form-control">
                        <option value="all">All Methods</option>
                        <option value="razorpay">Razorpay</option>
                        <option value="upi">UPI</option>
                        <option value="card">Card</option>
                        <option value="netbanking">Net Banking</option>
                    </select>
                </div>
                
                <div class="filter-group">
                    <label>Date Range</label>
                    <input type="text" id="paymentDateFilter" class="form-control" placeholder="Select date range">
                </div>
                
                <div class="filter-group">
                    <label>Search</label>
                    <div class="search-box">
                        <input type="text" id="searchPayments" class="form-control" placeholder="Search payments...">
                        <i class="fas fa-search"></i>
                    </div>
                </div>
            </div>
        </div>

        <!-- Payments Table -->
        <div class="table-section">
            <div class="table-actions">
                <div class="table-info">
                    Showing <span id="showingCount">0</span> of <span id="totalCount">0</span> payments
                </div>
                <div class="table-buttons">
                    <button class="btn btn-outline" id="exportPaymentsBtn">
                        <i class="fas fa-download"></i> Export CSV
                    </button>
                    <button class="btn btn-outline" id="printReportBtn">
                        <i class="fas fa-print"></i> Print Report
                    </button>
                </div>
            </div>
            
            <div class="table-responsive">
                <table class="data-table" id="paymentsTable">
                    <thead>
                        <tr>
                            <th>Transaction ID</th>
                            <th>Order ID</th>
                            <th>Customer</th>
                            <th>Amount</th>
                            <th>Method</th>
                            <th>Status</th>
                            <th>Date</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="paymentsTableBody">
                        <!-- Payments will be loaded here -->
                    </tbody>
                </table>
            </div>
            
            <div class="table-footer">
                <div class="pagination">
                    <button class="btn btn-outline" id="prevPage">
                        <i class="fas fa-chevron-left"></i>
                    </button>
                    <span class="page-info">Page <span id="currentPage">1</span> of <span id="totalPages">1</span></span>
                    <button class="btn btn-outline" id="nextPage">
                        <i class="fas fa-chevron-right"></i>
                    </button>
                </div>
                <div class="per-page">
                    <select id="perPage" class="form-control">
                        <option value="10">10 per page</option>
                        <option value="25" selected>25 per page</option>
                        <option value="50">50 per page</option>
                        <option value="100">100 per page</option>
                    </select>
                </div>
            </div>
        </div>

        <!-- Payment Details Modal -->
        <div class="modal" id="paymentModal">
            <div class="modal-content">
                <div class="modal-header">
                    <h3>Payment Details</h3>
                    <button class="modal-close">&times;</button>
                </div>
                <div class="modal-body">
                    <div class="payment-details">
                        <div class="detail-row">
                            <span class="detail-label">Transaction ID:</span>
                            <span class="detail-value" id="detailTransactionId">-</span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">Order ID:</span>
                            <span class="detail-value" id="detailOrderId">-</span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">Customer:</span>
                            <span class="detail-value" id="detailCustomer">-</span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">Email:</span>
                            <span class="detail-value" id="detailEmail">-</span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">Amount:</span>
                            <span class="detail-value" id="detailAmount">-</span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">Payment Method:</span>
                            <span class="detail-value" id="detailMethod">-</span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">Status:</span>
                            <span class="detail-value">
                                <span class="status-badge" id="detailStatus">-</span>
                            </span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">Date:</span>
                            <span class="detail-value" id="detailDate">-</span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">Description:</span>
                            <span class="detail-value" id="detailDescription">-</span>
                        </div>
                    </div>
                    
                    <div class="modal-actions">
                        <button type="button" class="btn btn-secondary modal-cancel">Close</button>
                        <button type="button" class="btn btn-primary" id="sendReceiptBtn">
                            <i class="fas fa-envelope"></i> Send Receipt
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Refund Modal -->
        <div class="modal" id="refundModal">
            <div class="modal-content">
                <div class="modal-header">
                    <h3>Process Refund</h3>
                    <button class="modal-close">&times;</button>
                </div>
                <div class="modal-body">
                    <form id="refundForm">
                        <div class="form-group">
                            <label>Transaction ID</label>
                            <input type="text" id="refundTransactionId" class="form-control" readonly>
                        </div>
                        
                        <div class="form-group">
                            <label>Amount to Refund</label>
                            <div class="amount-input">
                                <span class="currency">₹</span>
                                <input type="number" id="refundAmount" class="form-control" min="1" step="0.01">
                            </div>
                            <small class="form-text">Maximum refundable amount: <span id="maxRefundAmount">₹0.00</span></small>
                        </div>
                        
                        <div class="form-group">
                            <label>Refund Reason</label>
                            <select id="refundReason" class="form-control" required>
                                <option value="">Select reason</option>
                                <option value="duplicate">Duplicate Payment</option>
                                <option value="cancelled">Order Cancelled</option>
                                <option value="customer_request">Customer Request</option>
                                <option value="service_not_provided">Service Not Provided</option>
                                <option value="other">Other</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label>Notes (Optional)</label>
                            <textarea id="refundNotes" class="form-control" rows="3" placeholder="Add additional notes..."></textarea>
                        </div>
                        
                        <div class="modal-actions">
                            <button type="button" class="btn btn-secondary modal-cancel">Cancel</button>
                            <button type="submit" class="btn btn-danger">
                                <i class="fas fa-exchange-alt"></i> Process Refund
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script src="assets/js/admin.js"></script>
    <script>
        // Payments management specific JavaScript
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize date picker
            flatpickr('#paymentDateFilter', {
                mode: 'range',
                dateFormat: 'Y-m-d',
                defaultDate: [new Date().setDate(1), new Date()] // Current month
            });
            
            // Load payments
            loadPayments();
            
            // Event listeners
            document.getElementById('refreshPaymentsBtn').addEventListener('click', loadPayments);
            document.getElementById('exportPaymentsBtn').addEventListener('click', exportPayments);
            document.getElementById('printReportBtn').addEventListener('click', printReport);
            document.getElementById('searchPayments').addEventListener('input', filterPayments);
            document.getElementById('paymentStatusFilter').addEventListener('change', filterPayments);
            document.getElementById('paymentMethodFilter').addEventListener('change', filterPayments);
            document.getElementById('perPage').addEventListener('change', loadPayments);
            document.getElementById('prevPage').addEventListener('click', previousPage);
            document.getElementById('nextPage').addEventListener('click', nextPage);
            
            // Modal controls
            document.querySelectorAll('.modal-close').forEach(btn => {
                btn.addEventListener('click', closeModal);
            });
            
            document.querySelectorAll('.modal-cancel').forEach(btn => {
                btn.addEventListener('click', closeModal);
            });
            
            // Refund form
            document.getElementById('refundForm').addEventListener('submit', processRefund);
            
            // Send receipt button
            document.getElementById('sendReceiptBtn').addEventListener('click', sendReceipt);
        });
        
        let currentPage = 1;
        let totalPages = 1;
        let perPage = 25;
        let filteredPayments = [];
        let currentPaymentDetails = null;
        
        function loadPayments() {
            // Get orders from localStorage
            const orders = JSON.parse(localStorage.getItem('typingOrders') || '[]');
            
            // Extract payments from orders
            const payments = extractPaymentsFromOrders(orders);
            
            // Update summary statistics
            updatePaymentStatistics(payments);
            
            // Apply filters
            filteredPayments = filterPaymentsList(payments);
            
            // Update counts
            updateCounts(filteredPayments.length, payments.length);
            
            // Paginate
            perPage = parseInt(document.getElementById('perPage').value);
            totalPages = Math.ceil(filteredPayments.length / perPage);
            currentPage = Math.min(currentPage, totalPages) || 1;
            
            // Get current page payments
            const start = (currentPage - 1) * perPage;
            const end = start + perPage;
            const pagePayments = filteredPayments.slice(start, end);
            
            // Display payments
            displayPayments(pagePayments);
            
            // Update pagination
            updatePagination();
            
            // Update badge
            document.getElementById('paymentsBadge').textContent = payments.length;
        }
        
        function extractPaymentsFromOrders(orders) {
            const payments = [];
            
            orders.forEach(order => {
                if (order.payment) {
                    payments.push({
                        transactionId: order.payment.transactionId || `txn_${order.orderId}`,
                        orderId: order.orderId,
                        customer: order.name,
                        email: order.email,
                        amount: order.payment.amount || order.price,
                        method: order.payment.method || 'razorpay',
                        status: order.payment.status || 'pending',
                        date: order.payment.timestamp || order.createdAt,
                        description: `Payment for ${order.service}`,
                        orderData: order
                    });
                }
            });
            
            // Sort by date (newest first)
            return payments.sort((a, b) => new Date(b.date) - new Date(a.date));
        }
        
        function updatePaymentStatistics(payments) {
            let totalRevenue = 0;
            let monthRevenue = 0;
            let successfulCount = 0;
            let pendingCount = 0;
            let failedCount = 0;
            
            const currentMonth = new Date().getMonth();
            const currentYear = new Date().getFullYear();
            
            payments.forEach(payment => {
                // Calculate totals
                if (payment.status === 'completed') {
                    totalRevenue += parseFloat(payment.amount) || 0;
                    
                    // Check if this month
                    const paymentDate = new Date(payment.date);
                    if (paymentDate.getMonth() === currentMonth && 
                        paymentDate.getFullYear() === currentYear) {
                        monthRevenue += parseFloat(payment.amount) || 0;
                    }
                }
                
                // Count by status
                switch(payment.status) {
                    case 'completed':
                        successfulCount++;
                        break;
                    case 'pending':
                        pendingCount++;
                        break;
                    case 'failed':
                        failedCount++;
                        break;
                }
            });
            
            // Update UI
            document.getElementById('totalRevenue').textContent = `₹${totalRevenue.toFixed(2)}`;
            document.getElementById('monthRevenue').textContent = `₹${monthRevenue.toFixed(2)}`;
            document.getElementById('successfulPayments').textContent = successfulCount;
            document.getElementById('pendingPayments').textContent = pendingCount;
            document.getElementById('failedPayments').textContent = failedCount;
            document.getElementById('totalTransactions').textContent = payments.length;
        }
        
        function filterPaymentsList(payments) {
            const searchTerm = document.getElementById('searchPayments').value.toLowerCase();
            const statusFilter = document.getElementById('paymentStatusFilter').value;
            const methodFilter = document.getElementById('paymentMethodFilter').value;
            
            return payments.filter(payment => {
                // Search filter
                if (searchTerm) {
                    const searchFields = [
                        payment.transactionId,
                        payment.orderId,
                        payment.customer,
                        payment.email
                    ].join(' ').toLowerCase();
                    
                    if (!searchFields.includes(searchTerm)) {
                        return false;
                    }
                }
                
                // Status filter
                if (statusFilter !== 'all' && payment.status !== statusFilter) {
                    return false;
                }
                
                // Method filter
                if (methodFilter !== 'all' && payment.method !== methodFilter) {
                    return false;
                }
                
                return true;
            });
        }
        
        function filterPayments() {
            currentPage = 1;
            loadPayments();
        }
        
        function displayPayments(payments) {
            const tbody = document.getElementById('paymentsTableBody');
            tbody.innerHTML = '';
            
            if (payments.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="8" class="text-center">
                            <div class="empty-state">
                                <i class="fas fa-credit-card"></i>
                                <h3>No payments found</h3>
                                <p>Try adjusting your filters</p>
                            </div>
                        </td>
                    </tr>
                `;
                return;
            }
            
            payments.forEach(payment => {
                const row = document.createElement('tr');
                
                // Format date
                const date = new Date(payment.date);
                const formattedDate = date.toLocaleDateString('en-IN', {
                    day: '2-digit',
                    month: 'short',
                    year: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                });
                
                // Status badge
                const statusClass = `status-${payment.status === 'completed' ? 'completed' : 
                                    payment.status === 'pending' ? 'pending' : 'cancelled'}`;
                const statusText = payment.status.charAt(0).toUpperCase() + payment.status.slice(1);
                
                // Method icon
                let methodIcon = 'fa-credit-card';
                let methodText = 'Card';
                
                switch(payment.method) {
                    case 'upi':
                        methodIcon = 'fa-mobile-alt';
                        methodText = 'UPI';
                        break;
                    case 'netbanking':
                        methodIcon = 'fa-university';
                        methodText = 'Net Banking';
                        break;
                    case 'razorpay':
                        methodIcon = 'fa-wallet';
                        methodText = 'Razorpay';
                        break;
                }
                
                row.innerHTML = `
                    <td><strong>${payment.transactionId}</strong></td>
                    <td>${payment.orderId}</td>
                    <td>
                        <div class="customer-info">
                            <strong>${payment.customer}</strong>
                            <small>${payment.email}</small>
                        </div>
                    </td>
                    <td>₹${parseFloat(payment.amount).toFixed(2)}</td>
                    <td>
                        <div class="payment-method">
                            <i class="fas ${methodIcon}"></i>
                            <span>${methodText}</span>
                        </div>
                    </td>
                    <td><span class="status-badge ${statusClass}">${statusText}</span></td>
                    <td>${formattedDate}</td>
                    <td>
                        <div class="action-buttons">
                            <button class="btn-icon" onclick="viewPaymentDetails('${payment.transactionId}')" title="View Details">
                                <i class="fas fa-eye"></i>
                            </button>
                            ${payment.status === 'completed' ? `
                            <button class="btn-icon" onclick="initiateRefund('${payment.transactionId}', ${payment.amount})" title="Refund">
                                <i class="fas fa-exchange-alt"></i>
                            </button>
                            ` : ''}
                            <button class="btn-icon" onclick="downloadReceipt('${payment.transactionId}')" title="Download Receipt">
                                <i class="fas fa-download"></i>
                            </button>
                        </div>
                    </td>
                `;
                
                tbody.appendChild(row);
            });
        }
        
        function updateCounts(showing, total) {
            document.getElementById('showingCount').textContent = showing;
            document.getElementById('totalCount').textContent = total;
        }
        
        function updatePagination() {
            document.getElementById('currentPage').textContent = currentPage;
            document.getElementById('totalPages').textContent = totalPages;
            
            // Enable/disable navigation buttons
            document.getElementById('prevPage').disabled = currentPage === 1;
            document.getElementById('nextPage').disabled = currentPage === totalPages;
        }
        
        function previousPage() {
            if (currentPage > 1) {
                currentPage--;
                loadPayments();
            }
        }
        
        function nextPage() {
            if (currentPage < totalPages) {
                currentPage++;
                loadPayments();
            }
        }
        
        function viewPaymentDetails(transactionId) {
            const payment = filteredPayments.find(p => p.transactionId === transactionId);
            if (!payment) return;
            
            currentPaymentDetails = payment;
            
            // Update modal details
            document.getElementById('detailTransactionId').textContent = payment.transactionId;
            document.getElementById('detailOrderId').textContent = payment.orderId;
            document.getElementById('detailCustomer').textContent = payment.customer;
            document.getElementById('detailEmail').textContent = payment.email;
            document.getElementById('detailAmount').textContent = `₹${parseFloat(payment.amount).toFixed(2)}`;
            document.getElementById('detailMethod').textContent = payment.method.toUpperCase();
            document.getElementById('detailDescription').textContent = payment.description;
            
            // Status badge
            const statusBadge = document.getElementById('detailStatus');
            statusBadge.textContent = payment.status.charAt(0).toUpperCase() + payment.status.slice(1);
            statusBadge.className = `status-badge status-${payment.status === 'completed' ? 'completed' : 
                                    payment.status === 'pending' ? 'pending' : 'cancelled'}`;
            
            // Format date
            const date = new Date(payment.date);
            document.getElementById('detailDate').textContent = date.toLocaleString('en-IN');
            
            // Show modal
            document.getElementById('paymentModal').classList.add('active');
        }
        
        function initiateRefund(transactionId, amount) {
            const payment = filteredPayments.find(p => p.transactionId === transactionId);
            if (!payment) return;
            
            // Update refund form
            document.getElementById('refundTransactionId').value = transactionId;
            document.getElementById('refundAmount').value = amount;
            document.getElementById('refundAmount').max = amount;
            document.getElementById('maxRefundAmount').textContent = `₹${parseFloat(amount).toFixed(2)}`;
            
            // Show refund modal
            document.getElementById('refundModal').classList.add('active');
        }
        
        function processRefund(e) {
            e.preventDefault();
            
            const transactionId = document.getElementById('refundTransactionId').value;
            const amount = document.getElementById('refundAmount').value;
            const reason = document.getElementById('refundReason').value;
            const notes = document.getElementById('refundNotes').value;
            
            if (!reason) {
                showNotification('Please select a refund reason', 'error');
                return;
            }
            
            if (!confirm(`Process refund of ₹${amount} for transaction ${transactionId}?`)) {
                return;
            }
            
            // In a real app, this would call your refund API
            // For demo, simulate refund
            setTimeout(() => {
                showNotification(`Refund of ₹${amount} processed successfully`, 'success');
                closeModal();
                
                // Update payment status
                const orders = JSON.parse(localStorage.getItem('typingOrders') || '[]');
                orders.forEach(order => {
                    if (order.payment && order.payment.transactionId === transactionId) {
                        order.payment.status = 'refunded';
                        order.payment.refund = {
                            amount: amount,
                            reason: reason,
                            notes: notes,
                            timestamp: new Date().toISOString()
                        };
                    }
                });
                
                localStorage.setItem('typingOrders', JSON.stringify(orders));
                loadPayments();
            }, 1000);
        }
        
        function sendReceipt() {
            if (!currentPaymentDetails) return;
            
            const email = currentPaymentDetails.email;
            
            // In a real app, this would call your email API
            showNotification(`Receipt sent to ${email}`, 'success');
            closeModal();
        }
        
        function downloadReceipt(transactionId) {
            const payment = filteredPayments.find(p => p.transactionId === transactionId);
            if (!payment) return;
            
            // Create receipt content
            const receiptContent = `
                Typing Services Receipt
                =======================
                
                Transaction ID: ${payment.transactionId}
                Order ID: ${payment.orderId}
                Date: ${new Date(payment.date).toLocaleString()}
                
                Customer Information:
                ---------------------
                Name: ${payment.customer}
                Email: ${payment.email}
                
                Payment Details:
                ----------------
                Amount: ₹${parseFloat(payment.amount).toFixed(2)}
                Method: ${payment.method.toUpperCase()}
                Status: ${payment.status}
                
                Description: ${payment.description}
                
                Thank you for your business!
                
                ---------------------------------
                Typing Services
                Contact: support@typingservices.com
            `;
            
            // Create download
            const blob = new Blob([receiptContent], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `receipt-${transactionId}.txt`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            showNotification('Receipt downloaded successfully', 'success');
        }
        
        function exportPayments() {
            const payments = extractPaymentsFromOrders(
                JSON.parse(localStorage.getItem('typingOrders') || '[]')
            );
            
            if (payments.length === 0) {
                showNotification('No payments to export', 'warning');
                return;
            }
            
            // Convert to CSV
            const headers = ['Transaction ID', 'Order ID', 'Customer', 'Email', 'Amount', 'Method', 'Status', 'Date'];
            const csvRows = [
                headers.join(','),
                ...payments.map(p => [
                    p.transactionId,
                    p.orderId,
                    `"${p.customer}"`,
                    p.email,
                    p.amount,
                    p.method,
                    p.status,
                    p.date
                ].join(','))
            ];
            
            const csvString = csvRows.join('\n');
            const blob = new Blob([csvString], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `payments-${new Date().toISOString().split('T')[0]}.csv`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            showNotification('Payments exported successfully', 'success');
        }
        
        function printReport() {
            // Create print-friendly content
            const printContent = `
                <html>
                <head>
                    <title>Payments Report</title>
                    <style>
                        body { font-family: Arial, sans-serif; margin: 20px; }
                        h1 { color: #333; }
                        .header { text-align: center; margin-bottom: 30px; }
                        .summary { display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px; margin-bottom: 30px; }
                        .summary-card { padding: 15px; border-radius: 5px; text-align: center; }
                        .success { background: #d4edda; color: #155724; }
                        .warning { background: #fff3cd; color: #856404; }
                        .danger { background: #f8d7da; color: #721c24; }
                        .info { background: #d1ecf1; color: #0c5460; }
                        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
                        th, td { border: 1px solid #ddd; padding: 10px; text-align: left; }
                        th { background-color: #f8f9fa; }
                        .footer { margin-top: 50px; text-align: center; color: #666; font-size: 12px; }
                    </style>
                </head>
                <body>
                    <div class="header">
                        <h1>Payments Report</h1>
                        <p>Generated on ${new Date().toLocaleString()}</p>
                    </div>
                    
                    <div class="summary">
                        <div class="summary-card success">
                            <h3>${document.getElementById('successfulPayments').textContent}</h3>
                            <p>Successful</p>
                        </div>
                        <div class="summary-card warning">
                            <h3>${document.getElementById('pendingPayments').textContent}</h3>
                            <p>Pending</p>
                        </div>
                        <div class="summary-card danger">
                            <h3>${document.getElementById('failedPayments').textContent}</h3>
                            <p>Failed</p>
                        </div>
                        <div class="summary-card info">
                            <h3>${document.getElementById('totalTransactions').textContent}</h3>
                            <p>Total</p>
                        </div>
                    </div>
                    
                    <table>
                        <thead>
                            <tr>
                                <th>Transaction ID</th>
                                <th>Order ID</th>
                                <th>Customer</th>
                                <th>Amount</th>
                                <th>Method</th>
                                <th>Status</th>
                                <th>Date</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${filteredPayments.map(p => `
                                <tr>
                                    <td>${p.transactionId}</td>
                                    <td>${p.orderId}</td>
                                    <td>${p.customer}</td>
                                    <td>₹${parseFloat(p.amount).toFixed(2)}</td>
                                    <td>${p.method}</td>
                                    <td>${p.status}</td>
                                    <td>${new Date(p.date).toLocaleDateString()}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                    
                    <div class="footer">
                        <p>Total Revenue: ${document.getElementById('totalRevenue').textContent} | This Month: ${document.getElementById('monthRevenue').textContent}</p>
                        <p>&copy; ${new Date().getFullYear()} Typing Services - All rights reserved</p>
                    </div>
                </body>
                </html>
            `;
            
            const printWindow = window.open('', '_blank');
            printWindow.document.write(printContent);
            printWindow.document.close();
            printWindow.print();
        }
        
        function closeModal() {
            document.getElementById('paymentModal').classList.remove('active');
            document.getElementById('refundModal').classList.remove('active');
            currentPaymentDetails = null;
        }
    </script>
</body>
</html>